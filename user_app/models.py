
import random
from datetime import timedelta
from django.utils import timezone
from django.contrib.auth.models import AbstractBaseUser, PermissionsMixin, BaseUserManager
from django.db import models
from django.core.validators import RegexValidator

INSURANCE_CHOICES = [
    ("Ø¨ÛŒÙ…Ù‡ Ø¯Ø±Ù…Ø§Ù†ÛŒ Ø§ÛŒØ±Ø§Ù†", "Ø¨ÛŒÙ…Ù‡ Ø¯Ø±Ù…Ø§Ù†ÛŒ Ø§ÛŒØ±Ø§Ù†"),
    ("Ø¨ÛŒÙ…Ù‡ Ø¯Ø±Ù…Ø§Ù† ØªØ§Ù…ÛŒÙ† Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ", "Ø¨ÛŒÙ…Ù‡ Ø¯Ø±Ù…Ø§Ù† ØªØ§Ù…ÛŒÙ† Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ"),
    ("Ø¨ÛŒÙ…Ù‡ Ø®Ø¯Ù…Ø§Øª Ø¯Ø±Ù…Ø§Ù†ÛŒ Ù†ÛŒØ±ÙˆÙ‡Ø§ÛŒ Ù…Ø³Ù„Ø­", "Ø¨ÛŒÙ…Ù‡ Ø®Ø¯Ù…Ø§Øª Ø¯Ø±Ù…Ø§Ù†ÛŒ Ù†ÛŒØ±ÙˆÙ‡Ø§ÛŒ Ù…Ø³Ù„Ø­"),
    ("Ø¨ÛŒÙ…Ù‡ Ø®Ø¯Ù…Ø§Øª Ø¯Ø±Ù…Ø§Ù†ÛŒ (Ø³Ù„Ø§Ù…Øª)", "Ø¨ÛŒÙ…Ù‡ Ø®Ø¯Ù…Ø§Øª Ø¯Ø±Ù…Ø§Ù†ÛŒ (Ø³Ù„Ø§Ù…Øª)"),
    ("Ø¨ÛŒÙ…Ù‡ Ø¯Ø§Ù†Ø§", "Ø¨ÛŒÙ…Ù‡ Ø¯Ø§Ù†Ø§"),
    ("Ø¨ÛŒÙ…Ù‡ Ú©ÙˆØ«Ø±", "Ø¨ÛŒÙ…Ù‡ Ú©ÙˆØ«Ø±"),
    ("Ø¨ÛŒÙ…Ù‡ Ù…Ù„Øª", "Ø¨ÛŒÙ…Ù‡ Ù…Ù„Øª"),
    ("Ø¨ÛŒÙ…Ù‡ Ù…Ø§", "Ø¨ÛŒÙ…Ù‡ Ù…Ø§"),
    ("Ø¨ÛŒÙ…Ù‡ Ø³ÛŒÙ†Ø§", "Ø¨ÛŒÙ…Ù‡ Ø³ÛŒÙ†Ø§"),
    ("Ø¨ÛŒÙ…Ù‡ Ø¯ÛŒ", "Ø¨ÛŒÙ…Ù‡ Ø¯ÛŒ"),
    ("Ø¨ÛŒÙ…Ù‡ Ø¨Ø§Ù†Ú© Ù…Ù„ÛŒ", "Ø¨ÛŒÙ…Ù‡ Ø¨Ø§Ù†Ú© Ù…Ù„ÛŒ"),
    ("Ø¨ÛŒÙ…Ù‡ Ø¨Ø§Ù†Ú© ØµØ§Ø¯Ø±Ø§Øª", "Ø¨ÛŒÙ…Ù‡ Ø¨Ø§Ù†Ú© ØµØ§Ø¯Ø±Ø§Øª"),
    ("Ø¨ÛŒÙ…Ù‡ Ø¨Ø§Ù†Ú© ØªØ¬Ø§Ø±Øª", "Ø¨ÛŒÙ…Ù‡ Ø¨Ø§Ù†Ú© ØªØ¬Ø§Ø±Øª"),
    ("Ø¨ÛŒÙ…Ù‡ Ø¨Ø§Ù†Ú© Ú©Ø´Ø§ÙˆØ±Ø²ÛŒ", "Ø¨ÛŒÙ…Ù‡ Ø¨Ø§Ù†Ú© Ú©Ø´Ø§ÙˆØ±Ø²ÛŒ"),
    ("Ø¨ÛŒÙ…Ù‡ Ø¨Ø§Ù†Ú© Ø³Ù¾Ù‡", "Ø¨ÛŒÙ…Ù‡ Ø¨Ø§Ù†Ú© Ø³Ù¾Ù‡"),
    ("Ø¨ÛŒÙ…Ù‡ Ø³Ø§Ù…Ø§Ù†", "Ø¨ÛŒÙ…Ù‡ Ø³Ø§Ù…Ø§Ù†"),
    ("Ø¨ÛŒÙ…Ù‡ Ù¾Ø§Ø³Ø§Ø±Ú¯Ø§Ø¯", "Ø¨ÛŒÙ…Ù‡ Ù¾Ø§Ø³Ø§Ø±Ú¯Ø§Ø¯"),
    ("Ø¨ÛŒÙ…Ù‡ Ø±Ø§Ø²ÛŒ", "Ø¨ÛŒÙ…Ù‡ Ø±Ø§Ø²ÛŒ"),
    ("Ø¨ÛŒÙ…Ù‡ Ú©Ø§Ø±Ø¢ÙØ±ÛŒÙ†", "Ø¨ÛŒÙ…Ù‡ Ú©Ø§Ø±Ø¢ÙØ±ÛŒÙ†"),
    ("Ø¨ÛŒÙ…Ù‡ Ù…Ø®Ø§Ø¨Ø±Ø§Øª Ø§ÛŒØ±Ø§Ù†", "Ø¨ÛŒÙ…Ù‡ Ù…Ø®Ø§Ø¨Ø±Ø§Øª Ø§ÛŒØ±Ø§Ù†"),
    ("Ø¨ÛŒÙ…Ù‡ Ù¾Ø§Ø±Ø³ÛŒØ§Ù†", "Ø¨ÛŒÙ…Ù‡ Ù¾Ø§Ø±Ø³ÛŒØ§Ù†"),
    ("Ø¨ÛŒÙ…Ù‡ Ø³Ø§ÛŒÙ¾Ø§", "Ø¨ÛŒÙ…Ù‡ Ø³Ø§ÛŒÙ¾Ø§"),
    ("Ø¨ÛŒÙ…Ù‡ Ø³Ø±Ù…Ø¯", "Ø¨ÛŒÙ…Ù‡ Ø³Ø±Ù…Ø¯"),
    ("Ø¨ÛŒÙ…Ù‡ Ø´Ù‡Ø±Ø¯Ø§Ø±ÛŒ", "Ø¨ÛŒÙ…Ù‡ Ø´Ù‡Ø±Ø¯Ø§Ø±ÛŒ"),
    ("Ø¨ÛŒÙ…Ù‡ Ú©Ù…Ú© Ø±Ø³Ø§Ù† Ø§ÛŒØ±Ø§Ù† ( SOS )", "Ø¨ÛŒÙ…Ù‡ Ú©Ù…Ú© Ø±Ø³Ø§Ù† Ø§ÛŒØ±Ø§Ù† ( SOS )"),
    ("Ø¨ÛŒÙ…Ù‡ ØªØ¬Ø§Ø±Øª Ù†Ùˆ", "Ø¨ÛŒÙ…Ù‡ ØªØ¬Ø§Ø±Øª Ù†Ùˆ"),
    ("Ø¨ÛŒÙ…Ù‡ Ø¢ØªÛŒÙ‡ Ø³Ø§Ø²Ø§Ù† Ø­Ø§ÙØ¸", "Ø¨ÛŒÙ…Ù‡ Ø¢ØªÛŒÙ‡ Ø³Ø§Ø²Ø§Ù† Ø­Ø§ÙØ¸"),
    ("Ø¨ÛŒÙ…Ù‡ ØµØ¯Ø§ Ùˆ Ø³ÛŒÙ…Ø§", "Ø¨ÛŒÙ…Ù‡ ØµØ¯Ø§ Ùˆ Ø³ÛŒÙ…Ø§"),
    ("Ø¨ÛŒÙ…Ù‡ Ø¢Ø³ÛŒØ§", "Ø¨ÛŒÙ…Ù‡ Ø¢Ø³ÛŒØ§"),
    ("Ø¨ÛŒÙ…Ù‡ Ù…ÛŒÙ‡Ù†", "Ø¨ÛŒÙ…Ù‡ Ù…ÛŒÙ‡Ù†"),
    ("Ø¨ÛŒÙ…Ù‡ Ø¢Ø±Ù…Ø§Ù†", "Ø¨ÛŒÙ…Ù‡ Ø¢Ø±Ù…Ø§Ù†"),
    ("Ø´Ø±Ú©Øª Ø§Ø±ØªÙ‚Ø§Ø¡ Ø³Ù„Ø§Ù…Øª Ù¾Ø§Ø³Ø§Ø±Ú¯Ø§Ø¯", "Ø´Ø±Ú©Øª Ø§Ø±ØªÙ‚Ø§Ø¡ Ø³Ù„Ø§Ù…Øª Ù¾Ø§Ø³Ø§Ø±Ú¯Ø§Ø¯"),
    ("Ø¨ÛŒÙ…Ù‡ Ù†ÙˆÛŒÙ†", "Ø¨ÛŒÙ…Ù‡ Ù†ÙˆÛŒÙ†"),
    ("Ø¨ÛŒÙ…Ù‡ Ø¨Ø§Ù†Ú© Ø±ÙØ§Ù‡", "Ø¨ÛŒÙ…Ù‡ Ø¨Ø§Ù†Ú© Ø±ÙØ§Ù‡"),
    ("Ø¨ÛŒÙ…Ù‡ Ø§Ù„Ø¨Ø±Ø²", "Ø¨ÛŒÙ…Ù‡ Ø§Ù„Ø¨Ø±Ø²"),
    ("Ø¨ÛŒÙ…Ù‡ ÙˆØ²Ø§Ø±Øª Ù†ÛŒØ±Ùˆ (Ù†ÛŒØ±Ùˆ Ú©Ø§Ø±Øª)", "Ø¨ÛŒÙ…Ù‡ ÙˆØ²Ø§Ø±Øª Ù†ÛŒØ±Ùˆ (Ù†ÛŒØ±Ùˆ Ú©Ø§Ø±Øª)"),
    ("Ø¨ÛŒÙ…Ù‡ Ù…Ø¹Ù„Ù…", "Ø¨ÛŒÙ…Ù‡ Ù…Ø¹Ù„Ù…"),
    ("Ø¨ÛŒÙ…Ù‡ ØªØ¹Ø§ÙˆÙ†", "Ø¨ÛŒÙ…Ù‡ ØªØ¹Ø§ÙˆÙ†"),
    ("Ú©Ø§Ø±Øª Ø·Ù„Ø§ÛŒÛŒ ÙØ±Ù‡Ù†Ú¯ÛŒØ§Ù†", "Ú©Ø§Ø±Øª Ø·Ù„Ø§ÛŒÛŒ ÙØ±Ù‡Ù†Ú¯ÛŒØ§Ù†"),
    ("ØµÙ†Ø§ÛŒØ¹ Ø§Ù„Ú©ØªØ±ÙˆÙ†ÛŒÚ©", "ØµÙ†Ø§ÛŒØ¹ Ø§Ù„Ú©ØªØ±ÙˆÙ†ÛŒÚ©"),
    ("Ù‡ÙˆØ§Ù¾ÛŒÙ…Ø§ÛŒÛŒ Ù‡Ù…Ø§", "Ù‡ÙˆØ§Ù¾ÛŒÙ…Ø§ÛŒÛŒ Ù‡Ù…Ø§"),
    ("Ù‡ÙˆØ§Ù¾ÛŒÙ…Ø§ÛŒÛŒ Ø¢Ø³Ù…Ø§Ù†", "Ù‡ÙˆØ§Ù¾ÛŒÙ…Ø§ÛŒÛŒ Ø¢Ø³Ù…Ø§Ù†"),
    ("Ø¨ÛŒÙ…Ù‡ ØµÙ†Ø¯ÙˆÙ‚ Ø¨Ø§Ø²Ù†Ø´Ø³ØªÚ¯ÛŒ Ú©Ø´ÙˆØ±ÛŒ", "Ø¨ÛŒÙ…Ù‡ ØµÙ†Ø¯ÙˆÙ‚ Ø¨Ø§Ø²Ù†Ø´Ø³ØªÚ¯ÛŒ Ú©Ø´ÙˆØ±ÛŒ"),
    ("Ø¢Ø³Ù¾Ø§", "Ø¢Ø³Ù¾Ø§"),
    ("Ø¢ØªÛŒÙ‡ Ø³Ø§Ø²Ø§Ù† Ø§ÛŒØ±Ø§Ù†", "Ø¢ØªÛŒÙ‡ Ø³Ø§Ø²Ø§Ù† Ø§ÛŒØ±Ø§Ù†"),
    ("Ø³Ù„Ø§Ù…Øª Ù¾ÙˆÛŒØ§", "Ø³Ù„Ø§Ù…Øª Ù¾ÙˆÛŒØ§"),
    ("ØªØ¨Ø³Ù… Ø³Ù¾ÛŒØ¯ Ø³Ù„Ø§Ù…Øª", "ØªØ¨Ø³Ù… Ø³Ù¾ÛŒØ¯ Ø³Ù„Ø§Ù…Øª"),
    ("Ø¨ÛŒÙ…Ù‡ Ø¨Ø§Ù†Ú© Ù…Ù„Øª", "Ø¨ÛŒÙ…Ù‡ Ø¨Ø§Ù†Ú© Ù…Ù„Øª"),
    ("Ø¨ÛŒÙ…Ù‡ Ø¢Ø³Ù…Ø§Ø±ÛŒ", "Ø¨ÛŒÙ…Ù‡ Ø¢Ø³Ù…Ø§Ø±ÛŒ"),
    ("Ø¨ÛŒÙ…Ù‡ Ù…Ø®Ø§Ø¨Ø±Ø§Øª", "Ø¨ÛŒÙ…Ù‡ Ù…Ø®Ø§Ø¨Ø±Ø§Øª"),
    ("Ø¨ÛŒÙ…Ù‡ Ù…Ù‡Ø± Ø§ÛŒØ±Ø§Ù†", "Ø¨ÛŒÙ…Ù‡ Ù…Ù‡Ø± Ø§ÛŒØ±Ø§Ù†"),
    ("Ø¨ÛŒÙ…Ù‡ Ø¨Ø§Ù†Ú© Ù…Ø±Ú©Ø²ÛŒ", "Ø¨ÛŒÙ…Ù‡ Ø¨Ø§Ù†Ú© Ù…Ø±Ú©Ø²ÛŒ"),
    ("Ø³Ø§Ù…Ø§Ù†Ù‡ Ø§Ù‚Ø³Ø§Ø·ÛŒ Ø¢Ù¾", "Ø³Ø§Ù…Ø§Ù†Ù‡ Ø§Ù‚Ø³Ø§Ø·ÛŒ Ø¢Ù¾"),
    ("Ø¨ÛŒÙ…Ù‡ Ø¨Ø§Ù†Ú© Ù…Ø³Ú©Ù†", "Ø¨ÛŒÙ…Ù‡ Ø¨Ø§Ù†Ú© Ù…Ø³Ú©Ù†"),
    ("Ú©Ø§Ù†ÙˆÙ† ÙˆÚ©Ù„Ø§", "Ú©Ø§Ù†ÙˆÙ† ÙˆÚ©Ù„Ø§"),
    ("Ø¨ÛŒÙ…Ù‡ Ø´Ø±Ú©Øª Ù†ÙØª ÙÙ„Ø§Øª Ù‚Ø§Ø±Ù‡", "Ø¨ÛŒÙ…Ù‡ Ø´Ø±Ú©Øª Ù†ÙØª ÙÙ„Ø§Øª Ù‚Ø§Ø±Ù‡"),
]


class CustomUserManager(BaseUserManager):
    def create_user(self, phone_number, **extra_fields):
        if not phone_number:
            raise ValueError('Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ† Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª')
        user = self.model(phone_number=phone_number, **extra_fields)
        # Ø¨Ø¯ÙˆÙ† set_password
        user.save(using=self._db)
        return user

    def create_superuser(self, phone_number, **extra_fields):
        extra_fields.setdefault('is_staff', True)
        extra_fields.setdefault('is_superuser', True)
        return self.create_user(phone_number, **extra_fields)


class CustomUser(AbstractBaseUser, PermissionsMixin):
    # ðŸ“ Ù„ÛŒØ³Øª Ø´Ù‡Ø±Ù‡Ø§ÛŒ Ø§Ø³ØªØ§Ù† Ù„Ø±Ø³ØªØ§Ù†
    CITY_CHOICES = [
        ('khorramabad', 'Ø®Ø±Ù…â€ŒØ¢Ø¨Ø§Ø¯'),
        ('borujerd', 'Ø¨Ø±ÙˆØ¬Ø±Ø¯'),
        ('dorud', 'Ø¯ÙˆØ±ÙˆØ¯'),
        ('kuhdasht', 'Ú©ÙˆÙ‡Ø¯Ø´Øª'),
        ('alishtar', 'Ø§Ù„Ø´ØªØ±'),
        ('noodshahr', 'Ù†ÙˆØ±Ø¢Ø¨Ø§Ø¯'),
        ('azna', 'Ø§Ø²Ù†Ø§'),
        ('aligdarzeh', 'Ø§Ù„ÛŒÚ¯ÙˆØ¯Ø±Ø²'),
        ('sepiddasht', 'Ø³Ù¾ÛŒØ¯Ø¯Ø´Øª'),
        ('poldokhtar', 'Ù¾Ù„Ø¯Ø®ØªØ±'),
    ]
    phone_regex = RegexValidator(
        regex=r'^09\d{9}$',
        message="Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø¨Ø§ÛŒØ¯ Ø¨Ø§ 09 Ø´Ø±ÙˆØ¹ Ø´ÙˆØ¯ Ùˆ 11 Ø±Ù‚Ù… Ø¨Ø§Ø´Ø¯. Ù…Ø«Ù„Ø§Ù‹: 09123456789"
    )
    phone_number = models.CharField(
        validators=[phone_regex],
        max_length=11,
        unique=True,  # Ø§ÛŒÙ† Ø®Ø· Ø§Ø¶Ø§ÙÙ‡ Ø¨Ø´Ù‡
        verbose_name="Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„"
    )
    first_name = models.CharField(max_length=30, verbose_name="Ù†Ø§Ù…")
    last_name = models.CharField(max_length=30, verbose_name="Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ")
    insurance = models.CharField(
        max_length=100,
        choices=INSURANCE_CHOICES,
        blank=True,
        null=True,
        verbose_name="Ù†ÙˆØ¹ Ø¨ÛŒÙ…Ù‡"
    )
    city = models.CharField(
        max_length=20,
        choices=CITY_CHOICES,
        verbose_name="Ø´Ù‡Ø±",
        blank=True  
    )
    birth_date = models.CharField(
        max_length=20, verbose_name="ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯", blank=True, null=True)
    history_of_illness = models.CharField(
        max_length=255, verbose_name="ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¨ÛŒÙ…Ø§Ø±ÛŒ", blank=True, null=True)
    is_active = models.BooleanField(default=True)
    is_staff = models.BooleanField(default=False)

    objects = CustomUserManager()

    USERNAME_FIELD = 'phone_number'
    REQUIRED_FIELDS = ['first_name', 'last_name']

    def __str__(self):
        return self.phone_number

    def set_password(self, raw_password):
        # ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø³Øª Ú©Ø±Ø¯Ù† Ù¾Ø³ÙˆØ±Ø¯
        pass

    def check_password(self, raw_password):
        # Ù‡Ù…ÛŒØ´Ù‡ False Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù†ØŒ Ú†ÙˆÙ† Ù¾Ø³ÙˆØ±Ø¯ Ù†Ø¯Ø§Ø±ÛŒÙ…
        return False


class OTP(models.Model):
    phone_number = models.CharField(max_length=15)
    code = models.CharField(max_length=6)
    created_at = models.DateTimeField(auto_now_add=True)

    def is_valid(self):

        return self.created_at >= timezone.now() - timedelta(minutes=2)
